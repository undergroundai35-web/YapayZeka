@model List<UniCP.Models.MsK.SpModels.SSP_N4B_TICKETLARI>
@{
    ViewData["Title"] = "Destek Talepleri (Next4Biz)";
    Layout = "~/Views/Shared/_LayoutMusteri.cshtml";
}

<div class="space-y-6 animate-in fade-in duration-500">
    <!-- Dynamic Header & Stats Row -->
    @{
        var totalTickets = Model?.Count ?? 0;
        var escalatedTickets = Model?.Count(x => (x.SLA_YD_Cozum_Kalan_Sure ?? 0) < 0 || (x.Bildirim_Durumu ?? "").Contains("Eskale")) ?? 0;
        var processingTickets = Model?.Count(x => (x.Bildirim_Durumu ?? "").Contains("Çalışılıyor") || (x.Bildirim_Durumu ?? "").Contains("Devam") || (x.Bildirim_Durumu ?? "").Contains("İşlemde")) ?? 0;
        var waitingTickets = Model?.Count(x => (x.Bildirim_Durumu ?? "").Contains("Bekleniyor") || (x.Bildirim_Durumu ?? "").Contains("Müşteri")) ?? 0;

        string GetStatusColor(string status)
        {
            var s = status ?? "";
            if (s.Contains("Beklet", StringComparison.OrdinalIgnoreCase)) return "#F472B6"; // Pink-400
            if (s.Contains("Üstlen", StringComparison.OrdinalIgnoreCase)) return "#60A5FA"; // Blue-400
            if (s.Contains("Eskale", StringComparison.OrdinalIgnoreCase) || s.Contains("Gecik", StringComparison.OrdinalIgnoreCase)) return "#F87171"; // Red-400
            if (s.Contains("Analiz", StringComparison.OrdinalIgnoreCase)) return "#A78BFA"; // Violet-400
            if (s.Contains("Geliş", StringComparison.OrdinalIgnoreCase) || s.Contains("Develop", StringComparison.OrdinalIgnoreCase)) return "#FBBF24"; // Amber-400
            if (s.Contains("Test", StringComparison.OrdinalIgnoreCase)) return "#34D399"; // Emerald-400
            if (s.Contains("Müşteri", StringComparison.OrdinalIgnoreCase)) return "#E879F9"; // Fuchsia-400
            if (s.Contains("Açık", StringComparison.OrdinalIgnoreCase)) return "#22D3EE"; // Cyan-400
            return "#94A3B8"; // Slate-400
        }

        string GetStatusBg(string status)
        {
            var color = GetStatusColor(status);
            return color + "20"; // ~12% opacity hex alpha
        }
    }

    <!-- Header Section -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-white tracking-tight">Destek Talepleri</h1>
            <p class="text-sm text-slate-400 font-normal">Aktif destek talepleri ve SLA durumları</p>
        </div>
    </div>

    <!-- Stats Row (Large Cards) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Total Card -->
        <div class="glass-panel p-5 rounded-2xl group hover:bg-slate-800/50 transition-colors">
            <p class="text-[10px] font-normal text-slate-400 tracking-wide mb-1" style="text-transform: none;">Toplam Talep</p>
            <h3 class="text-2xl font-semibold text-white">@totalTickets</h3>
        </div>

        <!-- Escalated Card -->
        <div class="glass-panel p-5 rounded-2xl group hover:bg-slate-800/50 transition-colors">
            <div class="flex items-center gap-2 mb-1">
                <p class="text-[10px] font-normal text-slate-400 tracking-wide" style="text-transform: none;">Eskale / Kritik</p>
                @if(escalatedTickets > 0) {
                    <span class="flex h-1.5 w-1.5 rounded-full bg-red-500 animate-pulse"></span>
                }
            </div>
            <h3 class="text-2xl font-semibold text-red-400">@escalatedTickets</h3>
        </div>

        <!-- Processing Card -->
        <div class="glass-panel p-5 rounded-2xl group hover:bg-slate-800/50 transition-colors">
            <p class="text-[10px] font-normal text-slate-400 tracking-wide mb-1" style="text-transform: none;">Üzerinde Çalışılıyor</p>
            <h3 class="text-2xl font-semibold text-blue-400">@processingTickets</h3>
        </div>

        <!-- Waiting Card -->
        <div class="glass-panel p-5 rounded-2xl group hover:bg-slate-800/50 transition-colors">
            <p class="text-[10px] font-normal text-slate-400 tracking-wide mb-1" style="text-transform: none;">Müşteriden Bilgi Bekleniyor</p>
            <h3 class="text-2xl font-semibold text-fuchsia-400">@waitingTickets</h3>
        </div>
    </div>

    <!-- Main Table Container -->
    <div class="glass-panel rounded-2xl overflow-hidden min-h-[600px]">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-800/50 border-b border-white/5 text-[10px] capitalize tracking-wide text-slate-400 font-medium">
                        <th class="px-3 py-5 w-28 whitespace-nowrap">Talep No</th>
                        <th class="px-3 py-5">Talep</th>
                        <th class="px-3 py-5 w-32">Durum</th>
                        <th class="px-3 py-5 w-40">Firma</th>
                        <th class="px-3 py-5 w-32 text-center">Açılış tarihi</th>
                        <th class="px-3 py-5 w-32 text-center">Hedef tarihi</th>
                        <th class="px-3 py-5 w-48 text-left">SLA durumu</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    @if (Model != null && Model.Count > 0)
                    {
                        @foreach (var item in Model)
                        {
                            var totalSla = item.SLA_YD_Cozum_Sure ?? 0;
                            var kalan = item.SLA_YD_Cozum_Kalan_Sure ?? 0;
                            var isOverdue = kalan < 0;
                            var absKalan = Math.Abs(kalan);
                            
                            // Calculate Target Date and Progress (Remaining Time Logic)
                            var targetDate = DateTime.Now.AddDays((double)kalan);
                            var remainingPercent = totalSla > 0 ? (kalan / totalSla) * 100 : 0;
                            
                            // Clamp percentage
                            if (remainingPercent < 0) remainingPercent = 0; 
                            if (remainingPercent > 100) remainingPercent = 100;

                            // Gradient Progress Color Logic with narrower thresholds
                            string progressGradient;
                            string glowColor;
                            string pulseClass = "";
                            
                            if (isOverdue) {
                                progressGradient = "bg-gradient-to-r from-red-600 via-red-500 to-red-700";
                                glowColor = "rgba(220, 38, 38, 0.6)";
                                pulseClass = "animate-pulse";
                                remainingPercent = 100;
                            }
                            else if (remainingPercent < 50) {
                                progressGradient = "bg-gradient-to-r from-red-500 via-pink-500 to-red-400";
                                glowColor = "rgba(239, 68, 68, 0.5)";
                            }
                            else if (remainingPercent < 80) {
                                progressGradient = "bg-gradient-to-r from-orange-500 via-amber-400 to-yellow-500";
                                glowColor = "rgba(251, 146, 60, 0.5)";
                            }
                            else {
                                progressGradient = "bg-gradient-to-r from-emerald-500 via-green-400 to-emerald-600";
                                glowColor = "rgba(16, 185, 129, 0.5)";
                            }
                            
                            var statusColor = GetStatusColor(item.Bildirim_Durumu);
                            var statusBg = GetStatusBg(item.Bildirim_Durumu);
                            
                            <tr class="hover:bg-slate-800/50 transition-all duration-200 cursor-pointer group active:bg-slate-800 @(isOverdue ? "bg-red-500/5" : "")" onclick="window.location.href='/N4B/Details/@item.Bildirim_No'">
                                <td class="px-3 py-5 whitespace-nowrap">
                                    <span class="px-2.5 py-1 rounded-lg bg-indigo-500/10 text-indigo-400 text-[11px] font-medium border border-indigo-500/20">
                                        N4B-@item.Bildirim_No
                                    </span>
                                </td>
                                <td class="px-3 py-5">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-white group-hover:text-red-400 transition-colors line-clamp-1">
                                            @item.Bildirim_Aciklamasi
                                        </span>
                                        <span class="text-[10px] text-slate-400 font-medium mt-0.5 line-clamp-1">
                                            @(item.Bildirim_Aciklamasi?.Substring(0, Math.Min(item.Bildirim_Aciklamasi.Length, 60)) ?? "...")
                                        </span>
                                    </div>
                                </td>
                                <td class="px-3 py-5">
                                    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-[11px] font-medium whitespace-nowrap border border-white/5 capitalize" 
                                         style="background-color: @statusBg; color: @statusColor">
                                        <div class="w-1.5 h-1.5 rounded-full shadow-[0_0_5px_currentColor]" style="background-color: @statusColor"></div>
                                        <span>@item.Bildirim_Durumu</span>
                                    </div>
                                </td>
                                <td class="px-3 py-5">
                                    <span class="text-xs font-normal text-slate-300 line-clamp-1">@item.Firma</span>
                                </td>
                                <td class="px-3 py-5">
                                    <div class="flex flex-col items-center justify-center gap-1 text-xs text-slate-400 font-normal whitespace-nowrap">
                                        <span class="flex items-center gap-1.5 text-slate-300">
                                            <i class="bi bi-calendar4 text-[11px]"></i>
                                            @item.Bildirim_Tarihi.ToString("dd.MM.yyyy")
                                        </span>
                                        <span class="flex items-center gap-1.5 text-[10px]">
                                            <i class="bi bi-clock text-[10px]"></i>
                                            @item.Bildirim_Tarihi.ToString("HH:mm")
                                        </span>
                                    </div>
                                </td>
                                <td class="px-3 py-5">
                                    <div class="flex flex-col items-center justify-center gap-1 text-xs text-slate-400 font-normal whitespace-nowrap">
                                        <span class="flex items-center gap-1.5 text-slate-300">
                                            <i class="bi bi-flag-fill text-[11px]"></i>
                                            @targetDate.ToString("dd.MM.yyyy")
                                        </span>
                                        <span class="flex items-center gap-1.5 text-[10px]">
                                            <i class="bi bi-clock text-[10px]"></i>
                                            @targetDate.ToString("HH:mm")
                                        </span>
                                    </div>
                                </td>
                                <td class="px-3 py-5">
                                    <div class="flex flex-col gap-2 w-full max-w-[180px]">
                                        <!-- Animated Gradient Progress Bar -->
                                        <div class="relative h-2 w-full bg-slate-800/80 rounded-full overflow-hidden border border-white/10 shadow-inner">
                                            <div class="h-full rounded-full @progressGradient @pulseClass transition-all duration-700 ease-out relative overflow-hidden" 
                                                 style="width: @((int)remainingPercent)%; box-shadow: 0 0 15px @glowColor, inset 0 1px 0 rgba(255,255,255,0.3)">
                                                <!-- Shimmer Animation -->
                                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"></div>
                                            </div>
                                        </div>

                                        <!-- Footer: Remaining / Total Info -->
                                        <div class="flex justify-between items-center text-[9px] font-normal text-slate-500">
                                            <span>SLA: @totalSla.ToString("0.#") gün</span>
                                            <span class="@(isOverdue ? "text-red-400" : "text-emerald-400")">
                                               Kalan: @(isOverdue ? "-" : "")@absKalan.ToString("0.##") gün
                                            </span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center justify-center space-y-3">
                                    <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center">
                                        <i class="bi bi-ticket-detailed text-3xl text-slate-600"></i>
                                    </div>
                                    <p class="text-slate-500 text-sm font-normal">Henüz açık destek talebi bulunmuyor</p>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
